name: CI/CD Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    needs:
      [build-auth, build-courses, build-students, build-payments, build-bff]
    if: |
      success() &&
      github.event_name == 'push' && 
      (startsWith(github.ref, 'refs/heads/feature/') || 
       startsWith(github.ref, 'refs/heads/fix/') || 
       startsWith(github.ref, 'refs/heads/hotfix/'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || {
            sudo apt-get update
            sudo apt-get install -y gh
          }

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          existing_pr=$(gh pr list --head "$BRANCH" --base main --json number --jq .[0].number 2>/dev/null || echo "")
          if [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
            exit 0
          fi
          gh pr create \
            --head "$BRANCH" \
            --base main \
            --title "$BRANCH: automated PR" \
            --body "## Automated PR for branch: \`$BRANCH\`

            This PR was created automatically by GitHub Actions.

            When all CI checks pass âœ…, this PR can be merged to main." || echo "PR creation skipped"

  build-auth:
    uses: ./.github/workflows/ci-template.yml
    with:
      project_name: "AcademyIO.Auth.API"
      dockerfile_path: "./src/services/AcademyIO.Auth.API/Dockerfile"
      docker_image_name: "academyio-auth-api"
    secrets: inherit

  build-courses:
    uses: ./.github/workflows/ci-template.yml
    with:
      project_name: "AcademyIO.Courses.API"
      dockerfile_path: "./src/services/AcademyIO.Courses.API/Dockerfile"
      docker_image_name: "academyio-courses-api"
    secrets: inherit

  build-students:
    uses: ./.github/workflows/ci-template.yml
    with:
      project_name: "AcademyIO.Students.API"
      dockerfile_path: "./src/services/AcademyIO.Students.API/Dockerfile"
      docker_image_name: "academyio-students-api"
    secrets: inherit

  build-payments:
    uses: ./.github/workflows/payments-api-ci.yml
    secrets: inherit

  build-bff:
    uses: ./.github/workflows/ci-template.yml
    with:
      project_name: "AcademyIO.Bff"
      dockerfile_path: "./src/api-gateways/AcademyIO.Bff/Dockerfile"
      docker_image_name: "academyio-bff"
    secrets: inherit