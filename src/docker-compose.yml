version: '3.8'

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStrong!Passw0rd"
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "YourStrong!Passw0rd", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq/
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "status"]
      interval: 10s
      timeout: 3s
      retries: 5

  auth-api:
    build:
      context: .
      dockerfile: services/AcademyIO.Auth.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=AuthDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=true
      - MessageBus__ConnectionString=amqp://guest:guest@rabbitmq:5672/
    ports:
      - "8081:80"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  courses-api:
    build:
      context: .
      dockerfile: services/AcademyIO.Courses.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=CoursesDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=true
      - MessageBus__ConnectionString=amqp://guest:guest@rabbitmq:5672/
    ports:
      - "8082:80"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  students-api:
    build:
      context: .
      dockerfile: services/AcademyIO.Students.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=StudentsDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=true
      - MessageBus__ConnectionString=amqp://guest:guest@rabbitmq:5672/
    ports:
      - "8083:80"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  payments-api:
    build:
      context: .
      dockerfile: services/AcademyIO.Payments.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=PaymentsDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=true
    ports:
      - "8080:80"
    depends_on:
      sqlserver:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  bff:
    build:
      context: .
      dockerfile: api-gateways/AcademyIO.Bff/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - AppServicesSettings__AuthUrl=http://auth-api
      - AppServicesSettings__CourseUrl=http://courses-api
      - AppServicesSettings__StudentUrl=http://students-api
      - AppServicesSettings__PaymentUrl=http://payments-api
    ports:
      - "8084:80"
    depends_on:
      auth-api:
        condition: service_healthy
      courses-api:
        condition: service_healthy
      students-api:
        condition: service_healthy
      payments-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mssql-data:
  rabbitmq-data:
